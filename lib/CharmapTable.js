var ilib=require("./ilib.js");var Utils=require("./Utils.js");var Charset=require("./Charset.js");var Charmap=require("./Charmap.js");var IString=require("./IString.js");var CharmapTable=function(options){var sync=true,loadParams=undefined;this.parent.call(this,options);if(options){if(typeof options.charset==="object"){this.charset=options.charset}else if(typeof options.name!=="undefined"){this.charset=new Charset({name:options.name})}if(typeof options.sync!=="undefined"){sync=options.sync==true}if(typeof options.loadParams!=="undefined"){loadParams=options.loadParams}}if(!this.charset){this.charset=new Charset({name:"ISO-8859-15"})}this._calcExpansionFactor();if(!Charmap.cache){Charmap.cache={}}Utils.loadData({object:Charmap,locale:"-",nonlocale:true,name:"charmaps/"+this.charset.getName()+".json",sync:sync,loadParams:loadParams,callback:ilib.bind(this,function(mapping){if(!mapping){throw"No mapping found for "+this.charset.getName()}this.map=mapping;if(options&&typeof options.onLoad==="function"){options.onLoad(this)}})})};CharmapTable.prototype=new Charmap();CharmapTable.prototype.parent=Charmap;CharmapTable.prototype.constructor=CharmapTable;CharmapTable.prototype._trieWalk=function(trie,array,start){function isValue(node){return typeof node==="string"||typeof node==="number"||typeof node==="object"&&ilib.isArray(node)}var lastLeaf=undefined,i=start,trienode=trie;while(i<array.length){if(typeof trienode.__leaf!=="undefined"){lastLeaf={consumed:i-start+1,value:trienode.__leaf}}if(array[i]===0){return{consumed:1,value:0}}else if(typeof trienode[array[i]]!=="undefined"){if(isValue(trienode[array[i]])){return{consumed:i-start+1,value:trienode[array[i]]}}else{trienode=trienode[array[i++]]}}else{return lastLeaf}}return undefined};CharmapTable.prototype.mapToNative=function(string){if(!string){return new Uint8Array(0)}var str=string instanceof IString?string:new IString(string);var ret=new Uint8Array(str.length*this.expansionFactor);var i=0,j=0;while(i<string.length){var result=this._trieWalk(this.map.from,string,i);if(result){if(result.value){i+=result.consumed;j+=this.writeNative(ret,j,result.value)}else{i=string.length;this.writeNative(ret,j,[result.value])}}else{j+=this.writeNativeString(ret,j,this.dealWithMissingChar(string[i++]))}}return ret.subarray(0,j)};CharmapTable.prototype.mapToUnicode=function(bytes){var ret="";var i=0;while(i<bytes.length){var result=this._trieWalk(this.map.to,bytes,i);if(result){if(result.value){i+=result.consumed;if(typeof result.value==="string"){ret+=result.value}else if(ilib.isArray(result.value)){for(var j=0;j<result.value.length;j++){ret+=result.value[j]}}}else{i=bytes.length}}else{ret+=this.dealWithMissingChar(bytes[i++])}}return ret};Charmap._algorithms["CharmapTable"]=CharmapTable;module.exports=CharmapTable;