var Path=require("./Path.js");var ilib=require("./ilib.js");var Loader=require("./Loader.js");var Locale=require("./Locale.js");var WebLoader=function(ilib,sync,onLoad){this.parent.call(this,ilib);this._loadFile=navigator.userAgent.indexOf(" .NET")>-1?this._ieLoadFile:this._regularLoadFile;var base,root,pos,colon;var scripts=document.getElementsByTagName("script");pos=window.location.href.lastIndexOf("html");this.root=window.location.href.substring(0,pos);pos=this.root.lastIndexOf("/");this.root=this.root.substring(0,pos);colon=this.root.indexOf("://");this.root=Path.normalize(Path.join(this.root.substring(colon+3)));for(var i=0;i<scripts.length;i++){var source=scripts[i].src;if(source&&(pos=source.search(/\/ilib-[a-z\-]*\.js$/))!==-1){colon=source.indexOf("://");this.protocol=source.substring(0,colon+3);base=Path.join(source.substring(colon+3,pos-1),"..");break}}this.base=Path.normalize(Path.join(base||this.root,"data"));this.includePath.push(Path.join(this.root,"resources"));this._exists(Path.join(base,"locale"),"localeinfo.json");this._exists("/usr/share/javascript/ilib/locale","localeinfo.json")};WebLoader.prototype=new Loader();WebLoader.prototype.parent=Loader;WebLoader.prototype.constructor=WebLoader;WebLoader.prototype.name="WebLoader";WebLoader.prototype._ieLoadFile=function(pathname,sync,cb){var req=new ActiveXObject("MSXML2.XMLHTTP");var text=undefined;req.open("GET",this.protocol+pathname,!sync);if(!sync){req.onreadystatechange=function(){if(req.readyState===4){text=req.responseText;if(typeof cb==="function"){cb(text)}}}}try{req.send();text=req.responseText}catch(e){text=undefined}if(sync){if(typeof cb==="function"){cb(text)}}return text};WebLoader.prototype._regularLoadFile=function(pathname,sync,cb){var req=new XMLHttpRequest();var text=undefined;if(pathname.substring(0,this.protocol.length)!==this.protocol){pathname=this.protocol+pathname}req.open("GET",pathname,!sync);req.onload=function(e){text=req.response;if(typeof cb==="function"){cb(req.status===0||req.status===200?text:undefined)}};req.onerror=function(err){text=undefined;if(typeof cb==="function"){cb(undefined)}};try{req.send()}catch(e){text=undefined;if(typeof cb==="function"){cb(undefined)}}return text};WebLoader.prototype.getProperPath=function(params){var loc,language,script,region;var isExist,returnPath,dir;var baseResDir="resources";if(!params.name){return undefined}if(params){if(params.locale){this.locale=typeof params.locale==="string"?new Locale(params.locale):params.locale}if(params.name){this.name=params.name}if(params.baseResDir){baseResDir=params.baseResDir}loc=this.locale||new Locale();language=loc.getLanguage();script=loc.getScript();region=loc.getRegion();this.listAvailableFiles();if(language){dir=language+"/"+this.name;isExist=this.checkAvailability(dir);if(isExist){returnPath=dir}}if(script){dir=language+"/"+script+"/"+this.name;isExist=this.checkAvailability(dir);if(isExist){returnPath=dir}}if(region){if(script){dir=language+"/"+script+"/"+region+"/"+this.name}else{dir=language+"/"+region+"/"+this.name}isExist=this.checkAvailability(dir);if(isExist){returnPath=dir}}if(!returnPath){return this.name}}else{return undefined}return baseResDir+"/"+returnPath};module.exports=WebLoader;